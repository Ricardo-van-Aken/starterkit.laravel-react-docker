---
- name: Install Docker engine and verify with hello-world
  hosts: all
  become: true
  gather_facts: true
  vars:
    docker_user: "dockeruser"
    user_service_path: "/home/{{ docker_user }}/.config/systemd/user/docker.service"
    bashrc_path: "/home/{{ docker_user }}/.bashrc"

  tasks:
    - name: Get Docker user info
      ansible.builtin.user:
        name: "{{ docker_user }}"
      register: docker_user_info

    - name: Install Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    # - name: Ensure docker service is enabled and started
    #   ansible.builtin.service:
    #     name: docker
    #     enabled: yes
    #     state: started

    # - name: Wait for Docker socket to appear
    #   ansible.builtin.wait_for:
    #     path: /var/run/docker.sock
    #     state: present
    #     timeout: 30

    # - name: Run hello-world container to verify installation
    #   ansible.builtin.command: docker run --rm hello-world
    #   register: hello_result
    #   changed_when: hello_result.rc == 0
    #   failed_when: hello_result.rc != 0

    - name: Disable and stop Docker service and socket
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: no
      loop:
        - docker.service
        - docker.socket

    - name: Remove Docker socket file if present
      ansible.builtin.file:
        path: /var/run/docker.sock
        state: absent

    - name: check if rootless docker user service already exists
      ansible.builtin.stat:
        path: "{{ user_service_path }}"
      register: docker_user_service

    - name: dump environment from nspawn machine
      ansible.builtin.shell: >
        machinectl shell {{ docker_user }}@ /bin/bash -lc 'exec /usr/bin/dockerd-rootless-setuptool.sh install'
      args:
          creates: "/home/{{ docker_user }}/.config/systemd/user/docker.service"

    - name: ensure /usr/bin is added to PATH in .bashrc
      ansible.builtin.lineinfile:
        path: "{{ bashrc_path }}"
        regexp: '^export PATH=/usr/bin:\$PATH$'
        line: 'export PATH=/usr/bin:$PATH'
      become_user: "{{ docker_user }}"

    - name: ensure DOCKER_HOST is set in .bashrc
      ansible.builtin.lineinfile:
        path: "{{ bashrc_path }}"
        regexp: '^export DOCKER_HOST=unix:///run/user/[0-9]+/docker.sock$'
        line: "export DOCKER_HOST=unix:///run/user/$(id -u)/docker.sock"
      become_user: "{{ docker_user }}"

    # - name: Switch to the user context and run rootless install
    #   become: true
    #   become_user: "{{ docker_user }}"
    #   shell: |
    #     dockerd-rootless-setuptool.sh install
    #   args:
    #     creates: "/home/{{ docker_user }}/.config/systemd/user/docker.service"
    #   environment:
    #     XDG_RUNTIME_DIR: "/run/user/{{ docker_user_info.uid }}"
    #     PATH: "/usr/bin:$PATH"

    # - name: Check Docker is running rootless
    #   become: true
    #   become_user: "{{ docker_user }}"
    #   ansible.builtin.shell: docker info
    #   register: docker_info
    #   changed_when: false
    #   environment:
    #     XDG_RUNTIME_DIR: "/run/user/{{ docker_user_info.uid }}"
    #     PATH: "/usr/bin:$PATH"


    # - name: Check Docker is running rootless
    #   become: true
    #   become_user: "{{ docker_user }}"
    #   ansible.builtin.shell: docker info --format '{{ "{{" }} .Context {{"}}" }}'
    #   register: docker_info
    #   changed_when: false
    #   failed_when: docker_info.stdout | trim != 'rootless'

    # - name: Debug â€“ show docker context
    #   become: true
    #   become_user: "{{ docker_user }}"
    #   ansible.builtin.debug:
    #     msg: "Docker context is {{ docker_info.stdout | trim }}"
