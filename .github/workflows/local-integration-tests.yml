name: Run local integration tests

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    name: Run Laravel Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Laravel base image
        uses: docker/build-push-action@v5
        with:
          context: website
          file: website/docker/img_laravel/Dockerfile.laravel-base
          tags: laravel-base:latest
          push: false
          load: true

      - name: Build Docker Compose images
        working-directory: website
        run: |
          docker compose -f docker/docker-compose.yml --env-file docker/.env.testing --profile testing build

      - name: Start Docker services
        working-directory: website
        run: |
          docker compose -f docker/docker-compose.yml --env-file docker/.env.testing --profile testing up -d

      - name: Wait for services to be ready
        run: |
          echo "Waiting for database to be ready..."
          timeout 120 bash -c 'until docker exec db mysqladmin ping -h localhost --silent; do sleep 2; done'
          echo "Waiting for Laravel app to be ready..."
          timeout 120 bash -c 'until docker exec laravel_app php artisan --version; do sleep 2; done'

      - name: Run database migrations
        run: |
          docker exec -u www-data laravel_app sh -c '. /usr/local/bin/read-db-credentials.sh; php artisan migrate'

      - name: Run Laravel tests on clone of the empty main database
        run: |
          docker exec -u testrunner laravel_app sh -c '. /usr/local/bin/clone_and_test.sh'

      - name: Seed the main database with test data
        run: |
          docker exec -u www-data laravel_app sh -c '. /usr/local/bin/read-db-credentials.sh; php artisan db:seed'
      
      - name: Run Laravel tests on clone of the seeded main database
        run: |
          docker exec -u testrunner laravel_app sh -c '. /usr/local/bin/clone_and_test.sh'

      - name: Cleanup
        if: always()
        working-directory: website
        run: |
          docker compose -f docker/docker-compose.yml --env-file docker/.env.testing --profile testing down -v

