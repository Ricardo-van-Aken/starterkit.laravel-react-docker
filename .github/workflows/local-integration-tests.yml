name: Run local integration tests

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_REPO: ${{ vars.DOCKER_HUB_USERNAME }}/starterkit.laravel-react-docker

jobs:
  build-laravel-image:
    name: Build Laravel Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build Laravel base image
        uses: docker/build-push-action@v5
        with:
          context: website
          file: website/docker/img_laravel/Dockerfile.laravel-base
          tags: |
            ${{ env.IMAGE_REPO }}:laravel-base.latest
          push: true
          load: true
          cache-from: type=registry,ref=${{ env.IMAGE_REPO }}:laravel-base.latest
          cache-to: type=registry,ref=${{ env.IMAGE_REPO }}:laravel-base.latest,mode=max

      - name: Verify Laravel base image is available locally
        run: |
          if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^${{ env.IMAGE_REPO }}:laravel-base.latest$"; then
            echo "Laravel base image is available locally"
            docker images | grep "laravel-base.latest"
          else
            echo "Laravel base image is NOT available locally"
            exit 1
          fi

      - name: Debug BASE_IMAGE value
        run: |
          echo "IMAGE_REPO=${{ env.IMAGE_REPO }}"
          echo "BASE_IMAGE value should be: ${{ env.IMAGE_REPO }}:laravel-base.latest"

      - name: Build Laravel app image
        uses: docker/build-push-action@v5
        with:
          context: website
          file: website/docker/img_laravel/Dockerfile.laravel-volume
          build-args: |
            BASE_IMAGE=${{ env.IMAGE_REPO }}:laravel-base.latest
          tags: |
            ${{ env.IMAGE_REPO }}:laravel-app.latest
          push: true
          load: true
          pull: true
          cache-from: type=registry,ref=${{ env.IMAGE_REPO }}:laravel-app.latest
          cache-to: type=registry,ref=${{ env.IMAGE_REPO }}:laravel-app.latest,mode=max

      - name: Save images
        run: |
          mkdir -p docker-images
          docker save ${{ env.IMAGE_REPO }}:laravel-base.latest -o docker-images/laravel-base.tar
          docker save ${{ env.IMAGE_REPO }}:laravel-app.latest -o docker-images/laravel-app.tar

      - name: Upload images
        uses: actions/upload-artifact@v4
        with:
          name: image-app
          path: docker-images/*.tar
          retention-days: 1

  build-compose-images:
    name: Build Independent Compose Images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: nginx
            context: website/docker/img_nginx
            file: website/docker/img_nginx/Dockerfile.nginx
            tag: website-nginx.latest
          - name: mysql-db
            context: website/docker/img_mysqldb
            file: website/docker/img_mysqldb/Dockerfile.mysql
            tag: mysql-db.latest
          - name: cert-local
            context: website/docker/img_certlocal
            file: website/docker/img_certlocal/Dockerfile.cert-local
            tag: cert-local.latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build ${{ matrix.image.tag }} image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.file }}
          tags: |
            ${{ env.IMAGE_REPO }}:${{ matrix.image.tag }}
          push: true
          load: true
          cache-from: type=registry,ref=${{ env.IMAGE_REPO }}:${{ matrix.image.tag }}
          cache-to: type=registry,ref=${{ env.IMAGE_REPO }}:${{ matrix.image.tag }},mode=max

      - name: Save ${{ matrix.image.tag }} image
        run: |
          mkdir -p docker-images
          filename=$(echo "${{ matrix.image.name }}" | tr '/:' '_' | sed 's/__*/_/g' | sed 's/^_\|_$//g')
          docker save ${{ env.IMAGE_REPO }}:${{ matrix.image.tag }} -o docker-images/${filename}.tar

      - name: Upload ${{ matrix.image.tag }} image
        uses: actions/upload-artifact@v4
        with:
          name: image-${{ matrix.image.name }}
          path: docker-images/*.tar
          retention-days: 1

  collect-images:
    name: Collect All Images
    runs-on: ubuntu-latest
    needs: [build-laravel-image, build-compose-images]
    
    steps:
      - name: Download all images
        uses: actions/download-artifact@v4
        with:
          pattern: image-*
          merge-multiple: true
          path: docker-images

      - name: Upload all Docker images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/*.tar
          retention-days: 1

  test:
    name: Run Laravel Tests
    runs-on: ubuntu-latest
    needs: collect-images
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Pull base image from Docker Hub
        run: |
          docker pull ${{ env.IMAGE_REPO }}:laravel-base.latest
          docker tag ${{ env.IMAGE_REPO }}:laravel-base.latest laravel-base.latest

      - name: Download Docker Compose images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: docker-images

      - name: Load Docker Compose images
        run: |
          for image in docker-images/*.tar; do
            docker load -i "$image" || true
          done

      - name: Start Docker services
        working-directory: website
        run: |
          docker compose -f docker/docker-compose.yml --env-file docker/.env.testing --profile testing up -d

      - name: Wait for services to be ready
        run: |
          echo "Waiting for database to be ready..."
          timeout 120 bash -c 'until docker exec db mysqladmin ping -h localhost --silent; do sleep 2; done'
          echo "Waiting for Laravel app to be ready..."
          timeout 120 bash -c 'until docker exec laravel_app php artisan --version; do sleep 2; done'

      - name: Run database migrations
        run: |
          docker exec -u www-data laravel_app sh -c '. /usr/local/bin/read-db-credentials.sh; php artisan migrate'

      - name: Run Laravel tests on clone of the empty main database
        run: |
          docker exec -u testrunner laravel_app sh -c '. /usr/local/bin/clone_and_test.sh'

      - name: Seed the main database with test data
        run: |
          docker exec -u www-data laravel_app sh -c '. /usr/local/bin/read-db-credentials.sh; php artisan db:seed'
      
      - name: Run Laravel tests on clone of the seeded main database
        run: |
          docker exec -u testrunner laravel_app sh -c '. /usr/local/bin/clone_and_test.sh'

      - name: Cleanup
        if: always()
        working-directory: website
        run: |
          docker compose -f docker/docker-compose.yml --env-file docker/.env.testing --profile testing down -v

